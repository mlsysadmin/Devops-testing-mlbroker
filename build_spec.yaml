version: 0.1
component: build
timeoutInSeconds: 6000
runAs: root
shell: bash
env:
  variables:
    key: "value"
  exportedVariables:
    - BUILDRUN_HASH

steps:
  - type: Command
    name: "Define unique image tag"
    timeoutInSeconds: 40
    command: |
      export BUILDRUN_HASH=$(echo ${OCI_BUILD_RUN_ID} | rev | cut -c 1-7)
      echo "BUILDRUN_HASH: $BUILDRUN_HASH"
    onFailure:
      - type: Command
        command: |
          echo "Handling Failure"
          echo "Failure successfully handled"
        timeoutInSeconds: 40
        runAs: root

  - type: Command
    timeoutInSeconds: 1200
    name: "Build container image"
    command: |
      docker build --pull --rm -t nrt.ocir.io/nrcbpbtrtyz0/regs-container:${BUILDRUN_HASH} -f Dockerfile .

  - type: Command
    timeoutInSeconds: 1200
    name: "Push container image to registry"
    command: |
      docker push nrt.ocir.io/nrcbpbtrtyz0/regs-container:${BUILDRUN_HASH}
    onFailure:
      - type: Command
        command: |
          echo "Failed to create a docker image"
          echo "Failure successfully handled"
        timeoutInSeconds: 40
        runAs: root

  - type: Command
    name: "Upload artifact"
    timeoutInSeconds: 40
    command: |
      oci artifacts generic artifact upload-by-path \
          --repository-id ocid1.devopsdeployartifact.oc1.ap-tokyo-1.amaaaaaa46pqqoyaju5tunynouos245zkyll6bmxzdfy25wkkeppprzh6rgq \
          --artifact-path BACKEND-ml-brokerage-manifest \
          --artifact-version "${BUILDRUN_HASH}"
      echo "Artifact uploaded."
    onFailure:
      - type: Command
        command: |
          echo "Handling Failure"
          echo "Failure successfully handled"
        timeoutInSeconds: 40
        runAs: root

outputArtifacts:
  - name: output01
    type: DOCKER_IMAGE
    location: oci_devops_java_app:latest
