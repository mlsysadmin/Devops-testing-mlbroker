version: 0.1
component: build
timeoutInSeconds: 6000
runAs: root
shell: bash
env:
  variables:
    key: "value"
  exportedVariables:
    - BUILDRUN_HASH

phases:
  install:
    runtime-versions:
      nodejs: 18
    commands:
      - echo "Installing dependencies for bcrypt and node-gyp..."
      - apt-get update
      - apt-get install -y python3 make g++
  pre_build:
    commands:
      - echo "Starting build process at $(date)"
      - export npm_config_build_from_source=true # Force build from source for bcrypt
  build:
    commands:
      - echo "Running npm install..."
      - npm install # Install Node.js dependencies
      - echo "Building application..."
      - npm run build # Run any build script if required (e.g., for TypeScript or bundling)
  post_build:
    commands:
      - echo "Build completed at $(date)"
      - echo "Packaging application for deployment..."
      - zip -r application.zip . # Package for deployment if needed

steps:
  - type: Command
    name: "Define unique image tag"
    timeoutInSeconds: 40
    command: |
      export BUILDRUN_HASH=$(echo ${OCI_BUILD_RUN_ID} | rev | cut -c 1-7)
      echo "BUILDRUN_HASH: $BUILDRUN_HASH"
    onFailure:
      - type: Command
        command: |
          echo "Handling Failure"
          echo "Failure successfully handled"
        timeoutInSeconds: 40
        runAs: root

  - type: Command
    timeoutInSeconds: 1200
    name: "Build container image"
    command: |
      docker build --pull --rm -t nrt.ocir.io/nrcbpbtrtyz0/regs-container:${BUILDRUN_HASH} -f Dockerfile .

  - type: Command
    timeoutInSeconds: 1200
    name: "Push container image to registry"
    command: |
      docker push nrt.ocir.io/nrcbpbtrtyz0/regs-container:${BUILDRUN_HASH}
    onFailure:
      - type: Command
        command: |
          echo "Failed to create a docker image"
          echo "Failure successfully handled"
        timeoutInSeconds: 40
        runAs: root

  - type: Command
    name: "Upload artifact"
    timeoutInSeconds: 40
    command: |
      oci artifacts generic artifact upload-by-path \
          --repository-id ocid1.devopsdeployartifact.oc1.ap-tokyo-1.amaaaaaa46pqqoyaju5tunynouos245zkyll6bmxzdfy25wkkeppprzh6rgq \
          --artifact-path BACKEND-ml-brokerage
